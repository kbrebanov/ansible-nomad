nomad
=====

[![Build Status](https://travis-ci.org/kbrebanov/ansible-nomad.svg?branch=master)](https://travis-ci.org/kbrebanov/ansible-nomad)

Installs and configures Nomad

Requirements
------------

This role requires Ansible 1.9 or higher.

Role Variables
--------------

| Name                                             | Default                                                          | Description                                                                                                                                                                                                                                |
|:-------------------------------------------------|:-----------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| nomad_version                                    | 0.5.1                                                            | Version of Nomad to install                                                                                                                                                                                                                |
| nomad_sha256sum                                  | f93fc55d0c68883a28198c9fab93887f535c00193fce80b4be89cd09b6bbdb94 | SHA 256 checksum of package                                                                                                                                                                                                                |
| nomad_env_file                                   | /etc/profile.d/nomad.sh                                          | File which holds exported environment variables which will be used by Nomad agent service                                                                                                                                                  |
| nomad_client                                     | true                                                             | Install Nomad client (nomad_server must be false)                                                                                                                                                                                          |
| nomad_server                                     | false                                                            | Install Nomad server (nomad_client must be false)                                                                                                                                                                                          |
| nomad_telemetry                                  | false                                                            | Enable Nomad telemetry                                                                                                                                                                                                                     |
| nomad_atlas                                      | false                                                            | Enable Atlas                                                                                                                                                                                                                               |
| nomad_tls                                        | false                                                            | Enable TLS                                                                                                                                                                                                                                 |
| nomad_consul                                     | false                                                            | Enable Consul                                                                                                                                                                                                                              |
| nomad_vault                                      | false                                                            | Enable Vault integration                                                                                                                                                                                                                   |
| nomad_region                                     | "global"                                                         | Specifies the region the Nomad agent is a member of                                                                                                                                                                                        |
| nomad_datacenter                                 | "dc1"                                                            | Datacenter of the local agent                                                                                                                                                                                                              |
| nomad_name                                       | ''                                                               | The name of the local node                                                                                                                                                                                                                 |
| nomad_log_level                                  | "INFO"                                                           | Controls the verbosity of logs the Nomad agent will output. Valid log levels include "WARN", "INFO", or "DEBUG" in increasing order of verbosity                                                                                           |
| nomad_bind_addr                                  | "127.0.0.1"                                                      | Used to indicate which address the Nomad agent should bind to for network services, including the HTTP interface as well as the internal gossip protocol and RPC mechanism                                                                 |
| nomad_enable_debug                               | false                                                            | Enables the debugging HTTP endpoints                                                                                                                                                                                                       |
| nomad_ports_http                                 | 4646                                                             | The port used to run the HTTP server                                                                                                                                                                                                       |
| nomad_ports_rpc                                  | 4647                                                             | The port used for internal RPC communication between agents and servers, and for inter-server traffic for the consensus algorithm (raft)                                                                                                   |
| nomad_ports_serf                                 | 4648                                                             | The port used for the gossip protocol for cluster membership                                                                                                                                                                               |
| nomad_addresses_http                             | "{{ nomad_bind_addr }}"                                          | The address the HTTP server is bound to                                                                                                                                                                                                    |
| nomad_addresses_rpc                              | "{{ nomad_bind_addr }}"                                          | The address to bind the internal RPC interfaces to                                                                                                                                                                                         |
| nomad_addresses_serf                             | "{{ nomad_bind_addr }}"                                          | The address used to bind the gossip layer to                                                                                                                                                                                               |
| nomad_advertise_http                             | "{{ nomad_bind_addr }}"                                          | The address to advertise for the HTTP interface                                                                                                                                                                                            |
| nomad_advertise_rpc                              | "{{ nomad_bind_addr }}"                                          | The address to advertise for the RPC interface                                                                                                                                                                                             |
| nomad_advertise_serf                             | "{{ nomad_bind_addr }}"                                          | The address advertised for the gossip layer                                                                                                                                                                                                |
| nomad_leave_on_interrupt                         | false                                                            | Enables gracefully leaving when receiving the interrupt signal                                                                                                                                                                             |
| nomad_leave_on_terminate                         | false                                                            | Enables gracefully leaving when receiving the terminate signal                                                                                                                                                                             |
| nomad_enable_syslog                              | false                                                            | Enables logging to syslog                                                                                                                                                                                                                  |
| nomad_syslog_facility                            | "LOCAL0"                                                         | Controls the syslog facility that is used                                                                                                                                                                                                  |
| nomad_disable_update_check                       | false                                                            | Disables automatic checking for security bulletins and new version releases                                                                                                                                                                |
| nomad_disable_anonymous_signature                | false                                                            | Disables providing an anonymous signature for de-duplication with the update check                                                                                                                                                         |
| nomad_http_api_response_headers                  | {}                                                               | Specifies user-defined headers to add to the HTTP API responses                                                                                                                                                                            |
| nomad_telemetry_statsite_address                 | ''                                                               | Address of a statsite server to forward metrics data to                                                                                                                                                                                    |
| nomad_telemetry_statsd_address                   | ''                                                               | Address of a statsd server to forward metrics to                                                                                                                                                                                           |
| nomad_telemetry_datadog_address                  | ''                                                               | Address of a DataDog server to forward metrics to                                                                                                                                                                                          |
| nomad_telemetry_disable_hostname                 | false                                                            | Indicates if gauge values should not be prefixed with the local hostname                                                                                                                                                                   |
| nomad_telemetry_publish_allocation_metrics       | false                                                            | Specifies if Nomad should publish runtime metrics of allocations                                                                                                                                                                           |
| nomad_telemetry_publish_node_metrics             | false                                                            | Specifies if Nomad should publish runtime metrics of nodes                                                                                                                                                                                 |
| nomad_telemetry_circonus_api_token               | ''                                                               | Specifies a valid Circonus API Token used to create/manage check                                                                                                                                                                           |
| nomad_telemetry_circonus_api_app                 | "nomad"                                                          | Specifies a valid app name associated with the API token                                                                                                                                                                                   |
| nomad_telemetry_circonus_api_url                 | "https://api.circonus.com/v2"                                    | Specifies the base URL to use for contacting the Circonus API                                                                                                                                                                              |
| nomad_telemetry_circonus_submission_interval     | "10s"                                                            | Specifies the interval at which metrics are submitted to Circonus                                                                                                                                                                          |
| nomad_telemetry_circonus_submission_url          | ''                                                               | Specifies the check.config.submission_url field, of a Check API object, from a previously created HTTPTRAP check                                                                                                                           |
| nomad_telemetry_circonus_check_id                | ''                                                               | Specifies the Check ID (not check bundle) from a previously created HTTPTRAP check.                                                                                                                                                        |
| nomad_telemetry_circonus_force_metric_activation | false                                                            | Specifies if force activation of metrics which already exist and are not currently active                                                                                                                                                  |
| nomad_telemetry_circonus_check_instance_id       | ''                                                               | Serves to uniquely identify the metrics coming from this instance                                                                                                                                                                          |
| nomad_telemetry_circonus_check_search_tag        | ''                                                               | Specifies a special tag which, when coupled with the instance id, helps to narrow down the search results when neither a Submission URL or Check ID is provided                                                                            |
| nomad_telemetry_circonus_check_display_name      | ''                                                               | Specifies a name to give a check when it is created                                                                                                                                                                                        |
| nomad_telemetry_circonus_check_tags              | ''                                                               | Comma separated list of additional tags to add to a check when it is created                                                                                                                                                               |
| nomad_telemetry_circonus_broker_id               | ''                                                               | Specifies the ID of a specific Circonus Broker to use when creating a new check                                                                                                                                                            |
| nomad_telemetry_circonus_broker_select_tag       | ''                                                               | Specifies a special tag which will be used to select a Circonus Broker when a Broker ID is not provided                                                                                                                                    |
| nomad_server_bootstrap_expect                    | 3                                                                | This is an integer representing the number of server nodes to wait for before bootstrapping                                                                                                                                                |
| nomad_server_data_dir                            | "{{ nomad_data_dir }}/server"                                    | This is the data directory used for server-specific data, including the replicated log                                                                                                                                                     |
| nomad_server_protocol_version                    | ''                                                               | The Nomad protocol version spoken when communicating with other Nomad servers                                                                                                                                                              |
| nomad_server_num_schedulers                      | "{{ ansible_processor_cores }}"                                  | The number of parallel scheduler threads to run                                                                                                                                                                                            |
| nomad_server_enabled_schedulers                  | []                                                               | This is an array of strings indicating which sub-schedulers this server will handle                                                                                                                                                        |
| nomad_server_encrypt                             | ''                                                               | Specifies the secret key to use for encryption of Nomad server's gossip network traffic                                                                                                                                                    |
| nomad_client_state_dir                           | "{{ nomad_data_dir }}/client"                                    | This is the state dir used to store client state                                                                                                                                                                                           |
| nomad_client_alloc_dir                           | "{{ nomad_data_dir }}/alloc"                                     | A directory used to store allocation data                                                                                                                                                                                                  |
| nomad_client_servers                             | []                                                               | An array of server addresses                                                                                                                                                                                                               |
| nomad_client_node_id                             | ''                                                               | This is the value used to uniquely identify the local agent's node registration with the servers.                                                                                                                                          |
| nomad_client_node_class                          | ''                                                               | A string used to logically group client nodes by class. This can be used during job placement as a filter                                                                                                                                  |
| nomad_client_meta                                | {}                                                               | This is a key/value mapping of metadata pairs                                                                                                                                                                                              |
| nomad_client_max_kill_timeout                    | ''                                                               | Specifies the maximum amount of time a job is allowed to wait to exit                                                                                                                                                                      |
| nomad_client_chroot_env                          | {}                                                               | Specifies a key-value mapping that defines the chroot environment for jobs using the Exec and Java drivers                                                                                                                                 |
| nomad_client_options                             | {}                                                               | Specifies a key-value mapping of internal configuration for clients, such as for driver configuration                                                                                                                                      |
| nomad_client_network_interface                   | ''                                                               | Specifies the name of the interface to force network fingerprinting on                                                                                                                                                                     |
| nomad_client_network_speed                       | ''                                                               | Specifies an override for the network link speed                                                                                                                                                                                           |
| nomad_client_reserved_cpu                        | ''                                                               | Specifies that Nomad should reserve a portion of the node's CPU from receiving tasks                                                                                                                                                       |
| nomad_client_reserved_memory                     | ''                                                               | Specifies that Nomad should reserve a portion of the node's memory from receiving tasks                                                                                                                                                    |
| nomad_client_reserved_disk                       | ''                                                               | Specifies that Nomad should reserve a portion of the node's disk from receiving tasks                                                                                                                                                      |
| nomad_client_reserved_ports                      | ''                                                               | Specifies that Nomad should reserve a portion of the node's ports from receiving tasks                                                                                                                                                     |
| nomad_atlas_infrastructure                       | ''                                                               | The Atlas infrastructure name to connect this agent to                                                                                                                                                                                     |
| nomad_atlas_token                                | ''                                                               | The Atlas token to use for authentication                                                                                                                                                                                                  |
| nomad_atlas_join                                 | false                                                            | Indicates if the auto-join feature of Atlas should be enabled                                                                                                                                                                              |
| nomad_atlas_endpoint                             | ''                                                               | The address of the Atlas instance to connect to                                                                                                                                                                                            |
| nomad_server_node_gc_threshold                   | ''                                                               | Controls how long a node must be in a terminal state before it is garbage collected and purged from the system                                                                                                                             |
| nomad_server_rejoin_after_leave                  | ''                                                               | When provided, Nomad will ignore a previous leave and attempt to rejoin the cluster when starting                                                                                                                                          |
| nomad_server_retry_join                          | []                                                               | Similar to start_join but allows retrying a join if the first attempt fails                                                                                                                                                                |
| nomad_server_retry_interval                      | 30s                                                              | The time to wait between join attempts                                                                                                                                                                                                     |
| nomad_server_retry_max                           | 0                                                                | The maximum number of join attempts to be made before exiting with a return code of 1. By default, this is set to 0 which is interpreted as infinite retries                                                                               |
| nomad_server_start_join                          | []                                                               | An array of strings specifying addresses of nodes to join upon startup. If Nomad is unable to join with any of the specified addresses, agent startup will fail                                                                            |
| nomad_tls_http                                   | false                                                            | Specifies if TLS should be enabled on the HTTP endpoints on the Nomad agent, including the API                                                                                                                                             |
| nomad_tls_rpc                                    | false                                                            | Specifies if TLS should be enabled on the RPC endpoints and Raft traffic between the Nomad servers                                                                                                                                         |
| nomad_tls_verify_server_hostname                 | false                                                            | Specifies if outgoing TLS connections should verify the server's hostname                                                                                                                                                                  |
| nomad_tls_ca_file                                | ''                                                               | Specifies the path to the CA certificate to use for Nomad's TLS communication                                                                                                                                                              |
| nomad_tls_cert_file                              | ''                                                               | Specifies the path to the certificate file used for Nomad's TLS communication                                                                                                                                                              |
| nomad_tls_key_file                               | ''                                                               | Specifies the path to the key file to use for Nomad's TLS communication                                                                                                                                                                    |
| nomad_consul_address                             | "127.0.0.1:8500"                                                 | Specifies the address to the local Consul agent, given in the format host:port                                                                                                                                                             |
| nomad_consul_auth                                | ''                                                               | Specifies the HTTP Basic Authentication information to use for access to the Consul Agent, given in the format username:password                                                                                                           |
| nomad_consul_auto_advertise                      | true                                                             | Specifies if Nomad should advertise its services in Consul. The services are named according to server_service_name and client_service_name                                                                                                |
| nomad_consul_checks_use_advertise                | false                                                            | Specifies if Consul heath checks should bind to the advertise address                                                                                                                                                                      |
| nomad_consul_server_auto_join                    | true                                                             | Specifies if the Nomad servers should automatically discover and join other Nomad servers by searching for the Consul service name defined in the server_service_name option                                                               |
| nomad_consul_server_service_name                 | "nomad"                                                          | Specifies the name of the service in Consul for the Nomad servers                                                                                                                                                                          |
| nomad_consul_client_auto_join                    | true                                                             | Specifies if the Nomad clients should automatically discover servers in the same region by searching for the Consul service name defined in the server_service_name option                                                                 |
| nomad_consul_client_service_name                 | "nomad-client"                                                   | Specifies the name of the service in Consul for the Nomad clients                                                                                                                                                                          |
| nomad_consul_verify_ssl                          | true                                                             | Specifies if SSL peer verification should be used when communicating to the Consul API client over HTTPS                                                                                                                                   |
| nomad_consul_token                               | ''                                                               | Specifies the token used to provide a per-request ACL token                                                                                                                                                                                |
| nomad_consul_ca_file                             | ''                                                               | Specifies an optional path to the CA certificate used for Consul communication                                                                                                                                                             |
| nomad_consul_cert_file                           | ''                                                               | Specifies the path to the certificate used for Consul communication                                                                                                                                                                        |
| nomad_consul_key_file                            | ''                                                               | Specifies the path to the private key used for Consul communication                                                                                                                                                                        |
| nomad_vault_address                              | "https://127.0.0.1:8200"                                         | Specifies the address to the Vault server                                                                                                                                                                                                  |
| nomad_vault_allow_unauthenticated                | true                                                             | Specifies if users submitting jobs to the Nomad server should be required to provide their own Vault token, proving they have access to the policies listed in the job                                                                     |
| nomad_vault_tls_skip_verify                      | false                                                            | Specifies if SSL peer validation should be enforced                                                                                                                                                                                        |
| nomad_vault_tls_server_name                      | ''                                                               | Specifies an optional string used to set the SNI host when connecting to Vault via TLS                                                                                                                                                     |
| nomad_vault_token                                | ''                                                               | Specifies the parent Vault token to use to derive child tokens for jobs requesting tokens                                                                                                                                                  |
| nomad_vault_task_token_ttl                       | ''                                                               | Specifies the TTL of created tokens when using a root token                                                                                                                                                                                |
| nomad_vault_tls_ca_file                          | ''                                                               | Specifies an optional path to the CA certificate used for Vault communication                                                                                                                                                              |
| nomad_vault_tls_cert_file                        | ''                                                               | Specifies the path to the certificate used for Vault communication                                                                                                                                                                         |
| nomad_vault_tls_key_file                         | ''                                                               | Specifies the path to the private key used for Vault communication                                                                                                                                                                         |


Dependencies
------------

- [kbrebanov.unzip](https://github.com/kbrebanov/ansible-unzip)

Example Playbook
----------------

Install Nomad

```yaml
- hosts: all
  roles:
    - kbrebanov.nomad
```

Vault token
-----------

If you don't want to provide the vault token as a role variable you can set it up by exporting it as an environment variable on remote machine by creating a file:
```bash
# /etc/profile.d/nomad.sh

export VAULT_TOKEN=yourtoken
```

License
-------

BSD

Author Information
------------------

Kevin Brebanov
